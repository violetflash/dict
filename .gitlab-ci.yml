# GitLab CI/CD Pipeline
#
# Флоу работы:
# 1. При каждом пуше:
#    - Быстрая проверка линтером (quick-lint)
#
# 2. При пуше в main/develop или создании MR:
#    - Установка зависимостей (install)
#    - Сборка проекта (build)
#
# 3. Только при пуше в main:
#    - Деплой на Vercel (deploy)
#
# Кэширование:
# - node_modules и .npm-cache кэшируются для ускорения сборок
# - Ключ кэша зависит от ветки

image: node:18-alpine

variables:
  NODE_VERSION: '20.11.1'
  LINEAR_ACCESS_TOKEN: ${LINEAR_ACCESS_TOKEN}

stages:
  - install
  - lint
  - type-check
  - build
  - test
  - deploy
  - notify

cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - node_modules/
    - .npm-cache/

# Правила запуска пайплайна
workflow:
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "develop"
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - when: never

# Установка зависимостей
install:
  stage: install
  script:
    - npm install -g pnpm
    - pnpm install --frozen-lockfile
  artifacts:
    paths:
      - node_modules/

# Проверка линтером
lint:
  stage: lint
  script:
    - pnpm lint
  dependencies:
    - install

# Проверка типов
type-check:
  stage: type-check
  script:
    - pnpm type-check
  dependencies:
    - install

# Сборка проекта
build:
  stage: build
  script:
    - pnpm build
  artifacts:
    paths:
      - dist/
    expire_in: 1 week
  dependencies:
    - install

# Тесты
test:
  stage: test
  script:
    - pnpm test
  dependencies:
    - install

# Деплой
deploy:
  stage: deploy
  script:
    - echo "Deploy to production"
  only:
    - main
  dependencies:
    - build

# Уведомления
notify:
  stage: notify
  script:
    - echo "Notify about deployment"
  only:
    - main
  dependencies:
    - deploy

# Уведомления в Slack
notify_slack:
  stage: .post
  script:
    - |
      if [ $CI_PIPELINE_STATUS = "success" ]; then
        curl -X POST -H 'Content-type: application/json' --data "{\"text\":\"✅ Pipeline успешно выполнен в ветке $CI_COMMIT_BRANCH\"}" $SLACK_WEBHOOK_URL
      else
        curl -X POST -H 'Content-type: application/json' --data "{\"text\":\"❌ Pipeline завершился с ошибкой в ветке $CI_COMMIT_BRANCH\"}" $SLACK_WEBHOOK_URL
      fi
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
